// Generated by Hebron at 4/3/2022 2:10:11 AM

using System;
using System.Runtime.InteropServices;
using Hebron.Runtime;

namespace SqliteSharp
{
	unsafe partial class Sqlite
	{
		public static void createMask(WhereMaskSet* pMaskSet, int iCursor)
		{
			pMaskSet->ix[pMaskSet->n++] = (int)(iCursor);
		}
		public static ulong exprSelectUsage(WhereMaskSet* pMaskSet, Select pS)
		{
			ulong mask = (ulong)(0);
			while ((pS) != null)
			{
				SrcList pSrc = pS.pSrc;
				mask |= (ulong)(sqlite3WhereExprListUsage(pMaskSet, pS.pEList));
				mask |= (ulong)(sqlite3WhereExprListUsage(pMaskSet, pS.pGroupBy));
				mask |= (ulong)(sqlite3WhereExprListUsage(pMaskSet, pS.pOrderBy));
				mask |= (ulong)(sqlite3WhereExprUsage(pMaskSet, pS.pWhere));
				mask |= (ulong)(sqlite3WhereExprUsage(pMaskSet, pS.pHaving));
				if ((pSrc != null))
				{
					int i = 0;
					for (i = (int)(0); (i) < (pSrc.nSrc); i++)
					{
						mask |= (ulong)(exprSelectUsage(pMaskSet, pSrc.a[i].pSelect));
						mask |= (ulong)(sqlite3WhereExprUsage(pMaskSet, pSrc.a[i].pOn));
						if ((pSrc.a[i].fg.isTabFunc) != 0)
						{
							mask |= (ulong)(sqlite3WhereExprListUsage(pMaskSet, pSrc.a[i].u1.pFuncArg));
						}
					}
				}

				pS = pS.pPrior;
			}

			return (ulong)(mask);
		}
		public static ulong sqlite3WhereExprListUsage(WhereMaskSet* pMaskSet, ExprList pList)
		{
			int i = 0;
			ulong mask = (ulong)(0);
			if ((pList) != null)
			{
				for (i = (int)(0); (i) < (pList.nExpr); i++)
				{
					mask |= (ulong)(sqlite3WhereExprUsage(pMaskSet, pList.a[i].pExpr));
				}
			}

			return (ulong)(mask);
		}
		public static ulong sqlite3WhereExprUsage(WhereMaskSet* pMaskSet, Expr p)
		{
			return (ulong)(p ? sqlite3WhereExprUsageNN(pMaskSet, p) : 0);
		}
		public static ulong sqlite3WhereExprUsageFull(WhereMaskSet* pMaskSet, Expr p)
		{
			ulong mask = 0;
			mask = (ulong)(((p.op) == (179)) ? sqlite3WhereGetMask(pMaskSet, (int)(p.iTable)) : 0);
			if ((p.pLeft) != null)
				mask |= (ulong)(sqlite3WhereExprUsageNN(pMaskSet, p.pLeft));
			if ((p.pRight) != null)
			{
				mask |= (ulong)(sqlite3WhereExprUsageNN(pMaskSet, p.pRight));
			}
			else if ((((p).flags & 0x000800) != 0))
			{
				if ((((p).flags & (0x000020)) != 0))
					pMaskSet->bVarSelect = (int)(1);
				mask |= (ulong)(exprSelectUsage(pMaskSet, p.x.pSelect));
			}
			else if ((p.x.pList) != null)
			{
				mask |= (ulong)(sqlite3WhereExprListUsage(pMaskSet, p.x.pList));
			}

			if ((((p.op) == (172)) || ((p.op) == (168))) && (((p).flags & 0x1000000) != 0))
			{
				mask |= (ulong)(sqlite3WhereExprListUsage(pMaskSet, p.y.pWin.pPartition));
				mask |= (ulong)(sqlite3WhereExprListUsage(pMaskSet, p.y.pWin.pOrderBy));
				mask |= (ulong)(sqlite3WhereExprUsage(pMaskSet, p.y.pWin.pFilter));
			}

			return (ulong)(mask);
		}
		public static ulong sqlite3WhereExprUsageNN(WhereMaskSet* pMaskSet, Expr p)
		{
			if (((p.op) == (167)) && (!(((p).flags & (0x000008)) != 0)))
			{
				return (ulong)(sqlite3WhereGetMask(pMaskSet, (int)(p.iTable)));
			}
			else if ((((p).flags & (0x004000 | 0x800000)) != 0))
			{
				return (ulong)(0);
			}

			return (ulong)(sqlite3WhereExprUsageFull(pMaskSet, p));
		}
		public static ulong sqlite3WhereGetMask(WhereMaskSet* pMaskSet, int iCursor)
		{
			int i = 0;
			if ((pMaskSet->ix[0]) == (iCursor))
			{
				return (ulong)(1);
			}

			for (i = (int)(1); (i) < (pMaskSet->n); i++)
			{
				if ((pMaskSet->ix[i]) == (iCursor))
				{
					return (ulong)(((ulong)(1)) << (i));
				}
			}

			return (ulong)(0);
		}
	}
}